<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GSI Client ID tester</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px}
      input[type=text]{width:100%;padding:8px;font-size:14px}
      button{padding:8px 12px;margin-top:8px}
      pre{background:#f6f8fa;padding:12px;border-radius:6px;overflow:auto}
      .row{display:flex;gap:12px;align-items:center}
      .col{flex:1}
      .notice{color:#555;margin-bottom:8px}
    </style>
  </head>
  <body>
    <h1>Google Identity Services — Client ID tester</h1>
    <p class="notice">Paste a Google OAuth Client ID below (or use the prefilled one), then "Check status" to call the GSI status endpoint. "Init GSI" will try to load the GSI script and initialize it (you'll see console logs and on-screen results).</p>

    <label>Client ID</label>
    <input id="clientId" type="text" value="217184380827-ahiqdrhb1cp9cc1mvfa60o8rkvjqb0d9.apps.googleusercontent.com" />

    <div style="margin-top:10px" class="row">
      <div class="col">
        <button id="check">Check status (fetch)</button>
        <button id="init">Load GSI &amp; Initialize</button>
        <button id="render">Render Button</button>
      </div>
    </div>

    <h3>Result</h3>
    <div id="result">
      <pre id="output">(no output yet)</pre>
    </div>

    <h3>Console logs (captured)</h3>
    <pre id="logs">(no logs yet)</pre>

    <div id="gsi_button_target" style="margin-top:16px"></div>

    <script>
      const out = document.getElementById('output');
      const logs = document.getElementById('logs');
      const clientInput = document.getElementById('clientId');

      function log(msg){
        const time = new Date().toISOString();
        logs.textContent = time + ' - ' + msg + '\n' + logs.textContent;
        console.log(msg);
      }

      document.getElementById('check').addEventListener('click', async ()=>{
        const id = clientInput.value.trim();
        if(!id){ out.textContent = 'Please enter a client id'; return }
        out.textContent = 'Fetching https://accounts.google.com/gsi/status?client_id=' + encodeURIComponent(id);
        try{
          const r = await fetch('https://accounts.google.com/gsi/status?client_id=' + encodeURIComponent(id), { mode: 'cors' });
          const text = await r.text();
          out.textContent = 'HTTP ' + r.status + '\n' + text;
          log('status fetch -> HTTP ' + r.status);
        }catch(e){
          out.textContent = 'Request failed: ' + (e && e.message || e);
          log('fetch error: ' + (e && e.message || e));
        }
      });

      let gsiLoaded = false;
      document.getElementById('init').addEventListener('click', ()=>{
        const id = clientInput.value.trim();
        if(!id){ out.textContent = 'Please enter a client id'; return }
        if(window.google && window.google.accounts && window.google.accounts.id){
          out.textContent = 'GSI already loaded, initializing...';
          tryInit(id);
          return;
        }
        // load script
        const sId = 'gsi-test-script';
        if(document.getElementById(sId)){ out.textContent = 'GSI script exists, waiting init...'; tryInit(id); return }
        const s = document.createElement('script');
        s.src = 'https://accounts.google.com/gsi/client';
        s.async = true; s.defer = true; s.id = sId;
        s.onload = ()=>{ gsiLoaded = true; out.textContent = 'GSI script loaded. Trying to initialize...'; tryInit(id) };
        s.onerror = (err)=>{ out.textContent = 'Failed to load gsi script: ' + err; log('script load error ' + err) };
        document.head.appendChild(s);
        out.textContent = 'Loading gsi script...';
      });

      function tryInit(clientId){
        try{
          if(!(window.google && window.google.accounts && window.google.accounts.id)){
            out.textContent = 'GSI not available yet';
            return;
          }
          window.google.accounts.id.initialize({ client_id: clientId, callback: (res)=>{ log('credential callback: ' + JSON.stringify(res)); } });
          out.textContent = 'Initialized google.accounts.id with client_id: ' + clientId + '\nYou can call prompt() or render a button.';
          log('initialize called');
        }catch(e){
          out.textContent = 'initialize error: ' + (e && e.message || e);
          log('initialize error: ' + (e && e.message || e));
        }
      }

      document.getElementById('render').addEventListener('click', ()=>{
        const id = clientInput.value.trim();
        if(!(window.google && window.google.accounts && window.google.accounts.id)){
          out.textContent = 'GSI not loaded. Click "Load GSI & Initialize" first.'; return;
        }
        try{
          const target = document.getElementById('gsi_button_target');
          target.innerHTML = '';
          const btn = document.createElement('div');
          btn.id = 'gsiButton';
          target.appendChild(btn);
          window.google.accounts.id.renderButton(btn, { theme: 'outline', size: 'large' });
          out.textContent = 'renderButton called — check logs for any origin errors.';
          log('renderButton called');
        }catch(e){
          out.textContent = 'renderButton error: ' + (e && e.message || e);
          log('renderButton error: ' + (e && e.message || e));
        }
      });
    </script>
  </body>
</html>
